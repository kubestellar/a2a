name: Release

on:
  # Trigger on semantic version tags like v1.2.3
  push:
    tags:
      - "v*.*.*"
  # Allow manual runs from the Actions tab
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.1.0). If empty, uses GITHUB_REF_NAME."
        required: false
        default: ""
  # Also run when a GitHub Release is published from the UI
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: darwin
            arch: amd64
            runner: macos-13
          - os: darwin
            arch: arm64
            runner: macos-14
          - os: windows
            arch: amd64
            runner: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --dev

      - name: Install PyInstaller
        run: uv pip install pyinstaller

      - name: Build single-file binary
        run: uv run pyinstaller --onefile --name kubectl-kubestellar --distpath dist --workpath build packaging/entry_kubectl_a2a.py

      - name: Package artifact (tar.gz)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p release
          BIN_NAME="kubectl-kubestellar"
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            BIN_NAME="kubectl-kubestellar.exe"
          fi
          cp "dist/${BIN_NAME}" "release/${BIN_NAME}"
          ARCHIVE="kubectl-kubestellar-${{ matrix.os }}-${{ matrix.arch }}.tar.gz"
          tar -C release -czf "${ARCHIVE}" "${BIN_NAME}"
          # sha256
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "${ARCHIVE}" > "${ARCHIVE}.sha256"
          else
            shasum -a 256 "${ARCHIVE}" > "${ARCHIVE}.sha256"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: kubestellar-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            *.tar.gz
            *.sha256

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Resolve tag for this run
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          fi
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compute checksums summary
        run: |
          set -euxo pipefail
          cd artifacts
          find . -type f -name '*.tar.gz' -print0 | xargs -0 -I{} sha256sum "{}" > SHA256SUMS.txt || true
          find . -type f -name '*.tar.gz' -print0 | xargs -0 ls -l
          cat SHA256SUMS.txt || true

      - name: Generate Krew manifest
        id: manifest
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          # Resolve checksum values
          checksum() {
            local os=$1 arch=$2
            local file="artifacts/kubestellar-${os}-${arch}/kubectl-kubestellar-${os}-${arch}.tar.gz"
            if command -v sha256sum >/dev/null 2>&1; then
              sha256sum "$file" | awk '{print $1}'
            else
              shasum -a 256 "$file" | awk '{print $1}'
            fi
          }

          LINUX_AMD64=$(checksum linux amd64)
          DARWIN_AMD64=$(checksum darwin amd64)
          DARWIN_ARM64=$(checksum darwin arm64)
          WINDOWS_AMD64=$(checksum windows amd64)

          cat > kubestellar.yaml <<'YAML'
          apiVersion: krew.googlecontainertools.github.com/v1alpha2
          kind: Plugin
          metadata:
            name: kubestellar
          spec:
            version: REPLACE_VERSION
            homepage: https://github.com/kubestellar/a2a
            shortDescription: KubeStellar A2A multi-cluster management agent
            description: |
              Provides kubectl plugin commands for the KubeStellar Agent (A2A)
              to execute multi-cluster tasks, discovery, policy analysis, and
              more via `kubectl kubestellar`.
            platforms:
              - selector:
                  matchLabels:
                    os: linux
                    arch: amd64
                uri: REPLACE_BASE/kubectl-kubestellar-linux-amd64.tar.gz
                sha256: REPLACE_SHA_LINUX_AMD64
                bin: kubectl-kubestellar
              - selector:
                  matchLabels:
                    os: darwin
                    arch: amd64
                uri: REPLACE_BASE/kubectl-kubestellar-darwin-amd64.tar.gz
                sha256: REPLACE_SHA_DARWIN_AMD64
                bin: kubectl-kubestellar
              - selector:
                  matchLabels:
                    os: darwin
                    arch: arm64
                uri: REPLACE_BASE/kubectl-kubestellar-darwin-arm64.tar.gz
                sha256: REPLACE_SHA_DARWIN_ARM64
                bin: kubectl-kubestellar
              - selector:
                  matchLabels:
                    os: windows
                    arch: amd64
                uri: REPLACE_BASE/kubectl-kubestellar-windows-amd64.tar.gz
                sha256: REPLACE_SHA_WINDOWS_AMD64
                bin: kubectl-kubestellar.exe
YAML

          BASE_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG}"
          sed -i "s|REPLACE_VERSION|${TAG}|g" kubestellar.yaml
          sed -i "s|REPLACE_BASE|${BASE_URL}|g" kubestellar.yaml
          sed -i "s|REPLACE_SHA_LINUX_AMD64|${LINUX_AMD64}|g" kubestellar.yaml
          sed -i "s|REPLACE_SHA_DARWIN_AMD64|${DARWIN_AMD64}|g" kubestellar.yaml
          sed -i "s|REPLACE_SHA_DARWIN_ARM64|${DARWIN_ARM64}|g" kubestellar.yaml
          sed -i "s|REPLACE_SHA_WINDOWS_AMD64|${WINDOWS_AMD64}|g" kubestellar.yaml
          echo "Generated manifest:" && cat kubestellar.yaml

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.sha256
            kubestellar.yaml
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
